"""HTTP Security Headers Scanner."""
import aiohttp
from typing import Any, Dict, Tuple
from src.core.base_module import AtsModule, ModuleSpec, ModuleCategory, Parameter, ParameterType, OutputField

class HeaderSecurityModule(AtsModule):
    def get_spec(self) -> ModuleSpec:
        return ModuleSpec(name="header_security", category=ModuleCategory.PENTEST, description="HTTP security headers analyzer",
            version="1.0.0", parameters=[Parameter(name="url", type=ParameterType.URL, description="Target URL", required=True)],
            outputs=[OutputField(name="headers", type="dict", description="Security headers analysis")], tags=["headers", "security", "web"])
    
    def validate_inputs(self, config: Dict[str, Any]) -> Tuple[bool, str]:
        return (True, "") if config.get("url", "").startswith(("http://", "https://")) else (False, "Invalid URL")
    
    async def execute(self, config: Dict[str, Any]) -> Dict[str, Any]:
        url = config["url"]
        security_headers = ["Strict-Transport-Security", "Content-Security-Policy", "X-Frame-Options", "X-Content-Type-Options", "X-XSS-Protection", "Referrer-Policy", "Permissions-Policy"]
        async with aiohttp.ClientSession() as session:
            async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                headers = dict(resp.headers)
                found = {h: headers.get(h) for h in security_headers if h in headers}
                missing = [h for h in security_headers if h not in headers]
                score = int((len(found) / len(security_headers)) * 100)
                return {"found": found, "missing": missing, "score": score, "risk": "LOW" if score > 70 else "MEDIUM" if score > 40 else "HIGH"}
